version: '3.8'

x-worker: &worker_defaults
  image: constellation-dev
  cap_add:
    - NET_ADMIN
  volumes:
    - ../../:/constellation-rt
  networks:
    - constellation
  depends_on:
    - master
  tty: true
  stdin_open: true
  environment:
    - DMLC_PS_ROOT_URI=modelsynctime-controller
    - DMLC_PS_ROOT_PORT=8000
    - DMLC_ROLE=trainer
    - PS_VERBOSE=2
  restart: on-failure
  runtime: nvidia
  deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  working_dir:
     /constellation-rt/experiment/modelsynctime
  command: ["./entry_point.sh"]
  shm_size: '2gb'

services:
  master:
    image: constellation-dev
    cap_add:
      - NET_ADMIN
    container_name: modelsynctime-controller
    volumes:
      - ../..:/constellation-rt
    networks:
      - constellation
    working_dir:
     /constellation-rt/
    command: python3 ./experiment/modelsynctime/test_controller.py
    tty: true
    stdin_open: true
    env_file:
      - expconfig.env
    environment:
      - DMLC_PS_ROOT_URI=0.0.0.0
      - DMLC_PS_ROOT_PORT=8000
      - DMLC_ROLE=scheduler
      - PS_VERBOSE=2
    ipc: host

  worker:
    <<: *worker_defaults

networks:
  constellation:
    driver: bridge