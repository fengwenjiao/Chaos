## ConstelAggEngine：异步任务聚合与结果处理

### 概述

聚合引擎是 Trainer 中支持线程异步提交梯度聚合任务、返回梯度聚合结果的关键组件。

`ConstelAggEngine` 是一个复杂的多线程聚合引擎，
引擎的主要功能是收集由唯一ID标识的任务，并发处理这些任务，
然后将结果返回给调用线程。

### 主要功能与实现细节

#### 异步任务提交

`ConstelAggEngine` 通过其 `PushAsync` 方法支持异步任务提交。此方法允许任务在不阻塞调用者的情况下提交，从而实现高吞吐量和响应性。其工作原理如下：

1. **任务标识与数据处理**：每个任务都与一个唯一ID和对应的数据相关联。引擎确保每个任务的数据通过绑定回调函数（`ReturnOnAgg`
   ）正确处理。

2. **工作线程分配**：引擎根据当前负载和用户定义的测量函数（`MessureFunc`）动态分配任务到工作线程。这确保了任务的均衡分布，防止任何单个线程成为瓶颈。

3. **任务排队**：一旦分配，任务被推送到相应线程的任务队列（`ps::ThreadsafeQueue`）。每个线程连续处理其队列中的任务，保持高并发性。

#### 任务处理与结果聚合

任务由工作线程异步处理。处理过程涉及执行用户定义的数据处理函数（`DataHandle`
），该函数处理任务数据并生成结果。然后通过回调机制（`ReturnOnAgg`）返回结果。回调函数确保结果被收集并存储在共享容器（`res_ptr_`
）中，该容器以线程安全的方式访问。

1. **回调创建**：对于每个任务，使用 `CreateReturnCallBack` 创建一个 `ReturnOnAgg` 回调。该回调负责返回处理结果。

2. **结果处理**：回调调用 `CallBackReturnHandle`
   ，它锁定共享结果容器，插入结果，并增加已准备任务的计数。一旦所有任务准备就绪，会通知条件变量（`return_cv_`）以解除阻塞等待线程。

#### 同步等待结果

虽然任务是异步处理的，但 `ConstelAggEngine` 提供了一个同步等待所有结果的机制（`PushAndWait`）。

1. **任务提交**：通过 `PushAsync` 提交任务。

2. **等待完成**：调用线程等待条件变量（`return_cv_`），直到所有预期结果准备就绪。这确保了任务提交与结果聚合之间的同步。

#### 测量函数与负载均衡

用户可以定义负载衡量逻辑：通过 set_messure_func 方法设置自定义的负载衡量逻辑。该函数接收任务ID和任务数据，并返回一个表示任务负载的整数值。

`动态负载均衡`：引擎在分配任务到工作线程时，根据 MessureFunc 返回的负载值进行动态分配，确保任务均衡分布在各线程上。
